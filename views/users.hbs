<div class="users-container">
    <div class="users-header">
        <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span class="current-user">{{currentUser}}</span>!</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç.</p>
    </div>

    <div class="users-list">
        <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

        {{#if users.length}}
            {{#each users}}
                <div class="user-item {{#if online}}online{{else}}offline{{/if}}">
                    <div class="user-info">
                        <div class="user-avatar">
                            {{substr this.login 0 1}}
                        </div>
                        <div class="user-details">
                            <span class="user-login">{{this.login}}</span>
                            <span class="user-status">
                                <span class="status-dot {{#if online}}online{{else}}offline{{/if}}"></span>
                                {{#if online}}–í —Å–µ—Ç–∏{{else}}–ù–µ –≤ —Å–µ—Ç–∏{{/if}}
                            </span>
                        </div>
                    </div>
                    {{#if online}}
                        <a href="/chat?sessionId={{../sessionId}}&with={{this.login}}" class="chat-btn">
                            üí¨ –ß–∞—Ç
                        </a>
                    {{/if}}
                </div>
            {{/each}}
        {{else}}
            <div class="empty-state">
                <div style="font-size: 4rem; opacity: 0.5; margin-bottom: 20px;">üë•</div>
                <h3>–î—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –ø–µ—Ä–≤—ã–º–∏ –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—Å—è –¥—Ä—É–≥–∏–µ.</p>
            </div>
        {{/if}}
    </div>

    <div class="actions-container">
        <a href="/logout?sessionId={{sessionId}}" class="btn btn-logout">üö™ –í—ã–π—Ç–∏</a>
    </div>
</div>

<script>
    const sessionId = "{{sessionId}}";
    const currentUser = "{{currentUser}}";

    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.host;

    function getFirstLetter(str) {
        return str ? str.charAt(0).toUpperCase() : '?';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.user-avatar').forEach(avatar => {
            const login = avatar.closest('.user-item').querySelector('.user-login').textContent;
            avatar.textContent = getFirstLetter(login);
        });
    });

    const ws = new WebSocket(`${wsProtocol}//${wsHost}`);

    ws.onopen = () => {
        console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞.');
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);

            if (data.type === 'user_status') {
                const userItems = document.querySelectorAll('.user-item');
                userItems.forEach(item => {
                    const loginElement = item.querySelector('.user-login');
                    if (loginElement && loginElement.textContent === data.user) {
                        const statusElement = item.querySelector('.user-status');
                        const statusDot = item.querySelector('.status-dot');
                        const chatBtn = item.querySelector('.chat-btn');

                        if (data.online) {
                            item.classList.add('online');
                            item.classList.remove('offline');
                            statusElement.innerHTML = '<span class="status-dot online"></span> –í —Å–µ—Ç–∏';

                            if (!chatBtn) {
                                const newChatBtn = document.createElement('a');
                                newChatBtn.href = `/chat?sessionId=${sessionId}&with=${data.user}`;
                                newChatBtn.className = 'chat-btn';
                                newChatBtn.innerHTML = 'üí¨ –ß–∞—Ç';
                                item.appendChild(newChatBtn);
                            }
                        } else {
                            item.classList.add('offline');
                            item.classList.remove('online');
                            statusElement.innerHTML = '<span class="status-dot offline"></span> –ù–µ –≤ —Å–µ—Ç–∏';

                            if (chatBtn) {
                                chatBtn.remove();
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket:', error);
        }
    };

    ws.onerror = (error) => {
        console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
    };

    ws.onclose = () => {
        console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebSocket –∑–∞–∫—Ä—ã—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞.');
    };
</script>
