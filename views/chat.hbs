<div class="chat-container">
    <div class="chat-header">
        <div class="chat-header-info">
            <div class="chat-avatar" id="chatPartnerAvatar">
                {{substr withUser 0 1}}
            </div>
            <div class="chat-details">
                <h1>{{withUser}}</h1>
                <div class="chat-status">
                    <span class="status-dot online"></span>
                    <span id="statusText">–í —Å–µ—Ç–∏</span>
                </div>
            </div>
        </div>
        <a href="/users?sessionId={{sessionId}}" class="btn btn-back">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <div class="messages-container" id="messages">
        <div class="empty-state" id="emptyState">
            <div style="font-size: 4rem; opacity: 0.5; margin-bottom: 20px;">üí¨</div>
            <h3>–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</h3>
            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "{{withUser}}"</p>
        </div>
    </div>

    <div class="message-input-container">
        <input type="text" id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..." autocomplete="off">
        <button id="sendBtn" class="send-btn">‚Üë</button>
    </div>
</div>

<script>
    const currentUser = "{{currentUser}}";
    const withUser = "{{withUser}}";
    const sessionId = "{{sessionId}}";

    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.host;
    const wsUrl = `${wsProtocol}//${wsHost}`;

    const ws = new WebSocket(wsUrl);
    let isWsConnected = false;

    function getFirstLetter(str) {
        return str ? str.charAt(0).toUpperCase() : '?';
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }

    function hideEmptyState() {
        const emptyState = document.getElementById('emptyState');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
    }

    function initWebSocket() {
        ws.onopen = () => {
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket –¥–ª—è —á–∞—Ç–∞.');
            isWsConnected = true;
            ws.send(JSON.stringify({
                type: 'register',
                from: currentUser
            }));
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'message' && data.from === withUser) {
                    hideEmptyState();
                    addMessage(data.from, data.text, data.timestamp, false);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket:', error);
            }
        };

        ws.onerror = (error) => {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
            isWsConnected = false;
        };

        ws.onclose = () => {
            console.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebSocket –∑–∞–∫—Ä—ã—Ç–æ.');
            isWsConnected = false;

            const statusText = document.getElementById('statusText');
            const statusDot = document.querySelector('.chat-status .status-dot');
            if (statusText) statusText.textContent = '–ù–µ –≤ —Å–µ—Ç–∏';
            if (statusDot) statusDot.classList.remove('online');

            setTimeout(() => {
                console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket...');
                initWebSocket();
            }, 3000);
        };
    }

    function addMessage(from, text, timestamp, isSent) {
        const messagesDiv = document.getElementById('messages');

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

        const sender = isSent ? '–í—ã' : from;
        const time = formatTime(timestamp);

        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${sender}</span>
                    <span class="message-time">| ${time}</span>
                </div>
                <div class="message-text">${text}</div>
            </div>
        `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) return;

        if (isWsConnected && ws) {
            const message = {
                type: 'message',
                from: currentUser,
                to: withUser,
                text: text,
                timestamp: Date.now()
            };

            ws.send(JSON.stringify(message));
            hideEmptyState();
            addMessage(currentUser, text, Date.now(), true);
            input.value = '';
            input.focus();
        } else {
            alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è....');
            initWebSocket();
        }
    }

    async function loadMessages() {
        try {
            const response = await fetch(`/api/messages?sessionId=${sessionId}&with=${withUser}`);
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
            }
            const messages = await response.json();

            if (messages.length > 0) {
                hideEmptyState();

                messages.forEach(msg => {
                    const isSent = msg.from === currentUser;
                    addMessage(msg.from, msg.text, new Date(msg.timestamp).getTime(), isSent);
                });
            }

            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ ${messages.length} —Å–æ–æ–±—â–µ–Ω–∏—è(–∏–π)`);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const partnerAvatar = document.getElementById('chatPartnerAvatar');
        if (partnerAvatar) {
            partnerAvatar.textContent = getFirstLetter(withUser);
        }

        initWebSocket();
        loadMessages();

        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('messageInput').focus();
    });
</script>
